<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildlife Observation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        form {
            max-width: 500px;
            margin: 0 auto;
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input, button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Wildlife Observation</h1>
    <form id="observationForm" enctype="multipart/form-data">
        <label for="species">Species (Auto-detected):</label>
        <input type="text" id="species" name="species" readonly>

        <label for="confidence">Confidence (Auto-detected):</label>
        <input type="text" id="confidence" name="confidence" readonly>

        <label for="latitude">Latitude (Auto-detected):</label>
        <input type="text" id="latitude" name="latitude" readonly>

        <label for="longitude">Longitude (Auto-detected):</label>
        <input type="text" id="longitude" name="longitude" readonly>

        <label for="region">Region (Auto-detected):</label>
        <input type="text" id="region" name="region" readonly>

        <label for="date">Date (Auto-detected):</label>
        <input type="text" id="date" name="date" readonly>

        <label for="time">Time (Auto-detected):</label>
        <input type="text" id="time" name="time" readonly>

        <label for="image">Upload Image:</label>
        <input type="file" id="image" name="file" accept="image/*" required>

        <button type="submit">Submit Observation</button>
    </form>

    <script>
        // ✅ Function to Get Current Date & Time
        function getCurrentDateTime() {
            const now = new Date();
            document.getElementById("date").value = now.toISOString().split('T')[0]; // YYYY-MM-DD
            document.getElementById("time").value = now.toLocaleTimeString(); // HH:MM:SS
        }

        // ✅ Function to Auto-Detect Location (Latitude & Longitude)
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;

                        // Set Latitude & Longitude
                        document.getElementById("latitude").value = latitude;
                        document.getElementById("longitude").value = longitude;

                        // ✅ Fetch Region Name from OpenStreetMap API
                        getRegionFromCoordinates(latitude, longitude);
                    },
                    (error) => {
                        console.error("Error getting location:", error);
                        document.getElementById("latitude").value = "0.0";
                        document.getElementById("longitude").value = "0.0";
                        document.getElementById("region").value = "Location Unavailable";
                    }
                );
            } else {
                console.error("Geolocation not supported by this browser.");
                document.getElementById("latitude").value = "0.0";
                document.getElementById("longitude").value = "0.0";
                document.getElementById("region").value = "Location Unavailable";
            }
        }

        // ✅ Function to Get Region from Latitude & Longitude
        function getRegionFromCoordinates(latitude, longitude) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
                .then(response => response.json())
                .then(data => {
                    const region = data.address?.state || data.address?.country || "Unknown";
                    document.getElementById("region").value = region;
                })
                .catch(error => {
                    console.error("Error fetching region:", error);
                    document.getElementById("region").value = "Unknown";
                });
        }

        // ✅ Function to Handle Form Submission
        document.getElementById("observationForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append("file", document.getElementById("image").files[0]);
            formData.append("latitude", document.getElementById("latitude").value);
            formData.append("longitude", document.getElementById("longitude").value);
            formData.append("region", document.getElementById("region").value);
            formData.append("date", document.getElementById("date").value);
            formData.append("time", document.getElementById("time").value);

            console.log("Form data prepared:", {
                file: document.getElementById("image").files[0],
                latitude: document.getElementById("latitude").value,
                longitude: document.getElementById("longitude").value,
                region: document.getElementById("region").value,
                date: document.getElementById("date").value,
                time: document.getElementById("time").value
            });

            try {
                const response = await fetch("/predi", {
                    method: "POST",
                    body: formData
                });

                console.log("Response status:", response.status);

                const result = await response.json();
                console.log("Response data:", result);

                if (response.ok) {
                    document.getElementById("species").value = result.species;
                    document.getElementById("confidence").value = result.confidence;
                    alert("✅ Observation Submitted!");
                } else {
                    alert("❌ Failed to submit observation. Server returned an error.");
                }
            } catch (error) {
                console.error("Error submitting form:", error);
                alert("❌ Failed to submit observation. Check the console for details.");
            }
        });

        // ✅ Initialize Date, Time & Location on Page Load
        window.onload = () => {
            getCurrentDateTime();
            getUserLocation();
        };
    </script>
</body>
</html>
